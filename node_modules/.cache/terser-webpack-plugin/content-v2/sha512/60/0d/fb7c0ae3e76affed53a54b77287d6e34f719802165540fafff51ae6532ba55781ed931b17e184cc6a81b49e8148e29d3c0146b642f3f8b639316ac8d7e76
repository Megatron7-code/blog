{"code":"(window.webpackJsonp=window.webpackJsonp||[]).push([[15],{223:function(e,n,s){\"use strict\";s.r(n);var t=s(0),a=Object(t.a)({},(function(){var e=this,n=e.$createElement,s=e._self._c||n;return s(\"ContentSlotsDistributor\",{attrs:{\"slot-key\":e.$parent.slotKey}},[s(\"p\",[s(\"strong\",[e._v(\"利用sed命令、钉钉机器人上报服务器错误日志\")])]),e._v(\" \"),s(\"blockquote\",[s(\"p\",[e._v(\"后台处理日志一般采用ELK的架构，把日志打到Elasticsearch。有些小流量的应用可以采用直接上报的形式，省去了搭建ELK平台的繁琐。配合钉钉能快速感知。\")])]),e._v(\" \"),s(\"p\",[s(\"strong\",[e._v(\"实现思路：利用sed命令截取当前周期内产生的日志文件，通过钉钉群机器人上报。\")])]),e._v(\" \"),s(\"p\",[e._v(\"这里我们用Nginx、php产生的日志做讲解。\\n截取一段Nginx的错误日志：\")]),e._v(\" \"),s(\"div\",{staticClass:\"language-text extra-class\"},[s(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[s(\"code\",[e._v(\"2019/11/08 10:28:38 [error] 5136#0: *386932 FastCGI sent in stderr: \\\"PHP message: PHP Deprecated:  Automatically populating $HTTP_RAW_POST_DATA is deprecated and will be removed in a future version. To avoid this warning set 'always_populate_raw_post_data' to '-1' in php.ini and use the php://input stream instead. in Unknown on line 0\\\" while reading response header from upstream\\\"\\n\")])])]),s(\"p\",[e._v(\"利用sed命令截取，代码如下：\")]),e._v(\" \"),s(\"div\",{staticClass:\"language-shell extra-class\"},[s(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[s(\"code\",[e._v(\"sed -n '/2019\\\\/11\\\\/08\\\\s10:[0-9][0-9]:[0-9][0-9]\\\\s\\\\[error\\\\]/ p' nginx_error.log\\n\")])])]),s(\"p\",[e._v(\"截取php-fpm.log的日志\")]),e._v(\" \"),s(\"div\",{staticClass:\"language-text extra-class\"},[s(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[s(\"code\",[e._v(\"[15-Oct-2019 15:15:10] NOTICE: child 2054 stopped for tracing\\n[15-Oct-2019 15:15:10] NOTICE: about to trace 2054\\n[15-Oct-2019 15:15:10] ERROR: failed to ptrace(PEEKDATA) pid 2054: Input/output error (5)\\n[15-Oct-2019 15:15:10] NOTICE: finished trace of 2054\\n[15-Oct-2019 15:17:00] WARNING: [pool www] child 2051,\\n\")])])]),s(\"p\",[e._v(\"利用sed命令截取，代码如下：\")]),e._v(\" \"),s(\"div\",{staticClass:\"language-shell extra-class\"},[s(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[s(\"code\",[e._v(\"sed -n '/15-Oct-2019\\\\s15:[0-9][0-9]:[0-9][0-9]\\\\]\\\\s[ERROR|WARNING]/ p' php-fpm.log\\n\")])])]),s(\"p\",[e._v(\"整体shell脚本如下 log_report.sh：\")]),e._v(\" \"),s(\"div\",{staticClass:\"language-shell extra-class\"},[s(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[s(\"code\",[e._v(\"#!/bin/bash\\nPHP_LOG_PATH='/var/log/php-fpm.log'\\nNGINX_LOG_PATH='/var/log/nginx.error.log'\\nDING_TALK_URL='ding_talk_url'\\n\\nphp_log_process(){\\n\\t# 因为服务器改了语言环境，所以这里临时更换了下语言环境\\n    DATE_TIME=`env LANG=en_US.UTF-8 date +\\\"%d-%b-%Y %H\\\"`\\n    message=`sed -n '/'${DATE_TIME}':[0-9][0-9]:[0-9][0-9]\\\\]\\\\s[ERROR|WARNING]/ p' ${PHP_LOG_PATH}`\\n    echo $message\\n}\\n\\nnginx_log_process(){\\n    DATE_TIME=`env LANG=en_US.UTF-8 date +\\\"%Y\\\\/%m\\\\/%d\\\\s%H\\\"`\\n    message=`sed -n '/'${DATE_TIME}':[0-9][0-9]:[0-9][0-9]\\\\s\\\\[error\\\\]/ p' ${NGINX_LOG_PATH}`\\n    echo $message\\n}\\n\\n\\nmain(){\\n    res=`php_log_process`\\n    if test -z \\\"$res\\\";then\\n        echo 'The php log is empty'\\n    else\\n        push ${res//\\\\\\\"/-}\\n    fi\\n\\n    temp=`nginx_log_process`\\n    if test -z \\\"$temp\\\";then\\n        echo 'The nginx log is empty'\\n    else\\n        push ${temp//\\\\\\\"/-}\\n    fi\\n}\\n\\ntest1(){\\n    # message=`sed -n '/2019\\\\/11\\\\/06\\\\s16:[0-9][0-9]:[0-9][0-9]\\\\s\\\\[error\\\\]/ p' $NGINX_LOG_PATH`\\n    # message=`sed -n '/15-Oct-2019\\\\s15:[0-9][0-9]:[0-9][0-9]\\\\]\\\\s[ERROR|WARNING]/ p' $PHP_LOG_PATH`\\n\\n    DATE_TIME=`env LANG=en_US.UTF-8 date +\\\"%Y\\\\/%m\\\\/%d\\\\s%H\\\"`\\n    message=`sed -n '/'${DATE_TIME}':[0-9][0-9]:[0-9][0-9]\\\\s\\\\[error\\\\]/ p' ${NGINX_LOG_PATH}`\\n    # 判断是否有日志内容\\n    if test -z \\\"$message\\\";then\\n        echo 'is empty'\\n    else\\n        echo ${message//\\\\\\\"/-}\\n        push ${message//\\\\\\\"/-}\\n    fi\\n}\\n\\npush(){\\n    curl $DING_TALK_URL \\\\\\n       -H 'Content-Type: application/json' \\\\\\n       -d '{\\\"msgtype\\\": \\\"text\\\",\\n            \\\"text\\\": {\\n                 \\\"content\\\": \\\"'\\\"$*\\\"'\\\"\\n            }\\n          }'\\n}\\n\\nif [[ $1 == 'test' ]];then\\n    test1\\nelse\\n    main\\nfi\\n\")])])]),s(\"p\",[e._v(\"还需配合crontab 任务,这里有个策略就是把任务放在了第59分钟执行，这样就能把之前1小时内产生的日志抓取出来了\")]),e._v(\" \"),s(\"div\",{staticClass:\"language-shell extra-class\"},[s(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[s(\"code\",[e._v(\"# log report\\n59 * * * * /bin/sh log_report.sh\\n\")])])]),s(\"p\",[e._v(\"钉钉添加群聊自定义机器人过程略过。\\n效果图如下：\\n\"),s(\"img\",{attrs:{src:\"https://img-blog.csdnimg.cn/20191108111526749.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTA3MTE3NTA=,size_16,color_FFFFFF,t_70\",alt:\"钉钉信息截图\"}}),e._v(\" \"),s(\"center\",[e._v('\"欢迎关注我的公众号,一起交流讨论\"')])],1),e._v(\" \"),s(\"p\",[s(\"img\",{attrs:{src:\"https://img-blog.csdnimg.cn/20191109215625578.jpg#pic_center\",alt:\"在这里插入图片描述\"}})])])}),[],!1,null,null,null);n.default=a.exports}}]);","extractedComments":[]}